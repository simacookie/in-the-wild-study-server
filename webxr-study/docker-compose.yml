services:

  webserver:
    image: nginx
    container_name: nginx
    restart: unless-stopped
    networks:
      - proxy
    volumes:
      - "./nginx.conf:/etc/nginx/nginx.conf:ro"
      - "./html:/html"
      - "./survey:/survey"
      - "./module:/module"
      - "./vr-nugget:/vr-nugget"
      - "./knowledgetest:/knowledgetest"
    depends_on:
      in-the-wild-study_api:
        condition: service_healthy
#        condition: service_started
    labels:
      - "traefik.enable=true"
      # - "traefik.docker.network=proxy"
      - "traefik.http.routers.nginx.rule=Host(`webxr.imis.uni-luebeck.de`)"
      - 'traefik.http.routers.nginx.rule=Host(`webxr.imis.uni-luebeck.de`) && !PathPrefix(`/phpMyAdmin`)'
      - "traefik.http.routers.nginx.entrypoints=websecure"
      - "traefik.http.routers.nginx.tls=true" # comment out when using letsencrypt
      - "traefik.http.services.nginx.loadbalancer.server.port=80"

      # We use a cert file from the ITSC instead of letsencrypt
      # - "traefik.http.routers.nginx.tls.certresolver=letsencrypt"

  in-the-wild-study_api:
    image: in-the-wild-study_api:latest
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: in-the-wild-study_api
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3000                    # optional (app defaults to 3000)
    expose:
      - "3000"                       # visible to Nginx/Traefik on the network, not published to host
    networks:
      - proxy
      - backend
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      retries: 3

  db:
    image: mysql:8.0
    container_name: mysql
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=z8Ot6ApS3xS?U9XORRgw
      - MYSQL_DATABASE=in-the-wild-study_db
      - MYSQL_USER=wild-admin
      - MYSQL_PASSWORD=arozW67Rg7HR41O1!my4Y
    # Sensible defaults for modern Unicode + compatibility
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
    volumes:
      - db_data:/var/lib/mysql
      # Optional: auto-run SQL on first startup (create tables, etc.)
      # - ./mysql-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1",
            "-uimis", "-parozW67Rg7HR41O1!my4Y"]
      interval: 10s
      timeout: 3s
      retries: 10
    networks:
      - backend    # DB stays private; not on 'proxy'

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: phpmyadmin
    restart: unless-stopped
    environment:
      - PMA_HOST=db           # name of your MySQL service
      - PMA_PORT=3306
      - PMA_USER=wild-admin       # optional; you can set or just log in manually
      - PMA_PASSWORD=arozW67Rg7HR41O1!my4Y # match MYSQL_USER / MYSQL_PASSWORD from db
      # - PMA_ABSOLUTE_URI=https://webxr.mydomain.com/phpMyAdmin/  # optional
    networks:
      - proxy      # so Traefik can reach it
      - backend    # so it can reach MySQL
    # no ports: Traefik will handle external access
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"

      # Router: /phpMyAdmin on your existing domain
      - "traefik.http.routers.phpmyadmin.rule=Host(`webxr.imis.uni-luebeck.de`) && PathPrefix(`/phpMyAdmin`)"
      - "traefik.http.routers.phpmyadmin.entrypoints=websecure"
      - "traefik.http.routers.phpmyadmin.tls=true"
      - "traefik.http.routers.phpmyadmin.priority=20"

      # Service: talk to phpMyAdmin on container port 80
      - "traefik.http.services.phpmyadmin.loadbalancer.server.port=80"

      # Strip /phpMyAdmin prefix before hitting phpMyAdmin
      - "traefik.http.middlewares.pma-stripprefix.stripPrefix.prefixes=/phpMyAdmin"

      # Basic auth middleware (we'll fill the hash below)
      # User: imis
      # PW: hG28kgS1tlEb2FQ!xzSSf
      # Hash generated with: openssl passwd -apr1 hG28kgS1tlEb2FQ!xzSSf
      # Important: You need to double the $ symbols in the final hash for treafik to interpret them correctly
      - "traefik.http.middlewares.pma-auth.basicauth.users=imis:$$apr1$$rk8A6jLx$$.l4Y9Jf3jaNkgPhWH8vmQ."

      # Attach middlewares to router (order matters)
      - "traefik.http.routers.phpmyadmin.middlewares=pma-stripprefix,pma-auth"

networks:
  proxy:
    external: true
  backend:
    driver: bridge

volumes:
  db_data: